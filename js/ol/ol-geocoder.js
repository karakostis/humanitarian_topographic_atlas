/*!
 * ol-geocoder - v3.0.0
 * A geocoder extension for OpenLayers.
 * https://github.com/jonataswalker/ol-geocoder
 * Built: Tue Nov 14 2017 19:03:59 GMT-0200 (-02)
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("openlayers")):"function"==typeof define&&define.amd?define(["openlayers"],t):e.Geocoder=t(e.ol)}(this,function(e){"use strict";function t(e,t){if(void 0===t&&(t="Assertion failed"),!e){if("undefined"!=typeof Error)throw new Error(t);throw t}}function n(e){const t=function(){if("performance"in window==0&&(window.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in window.performance==0){let e=Date.now();performance.timing&&performance.timing.navigationStart&&(e=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-e}}return window.performance.now()}().toString(36);return e?e+t:t}function s(e){return/^\d+$/.test(e)}function r(e,t){return e.some(function(e){return t.indexOf(e)>=0})}function o(e,t,n){if(Array.isArray(e))return void e.forEach(function(e){return o(e,t)});const s=Array.isArray(t)?t:t.split(/\s+/);let r=s.length;for(;r--;)i(e,s[r])||d(e,s[r],n)}function a(e,t,n){if(Array.isArray(e))return void e.forEach(function(e){return a(e,t,n)});const s=Array.isArray(t)?t:t.split(/\s+/);let r=s.length;for(;r--;)i(e,s[r])&&h(e,s[r],n)}function i(e,t){return e.classList?e.classList.contains(t):p(t).test(e.className)}function c(e,t,n){void 0===t&&(t=window.document);let s=/\./g,r=Array.prototype.slice,o=[];if(/^(#?[\w-]+|\.[\w-.]+)$/.test(e))switch(e[0]){case"#":o=[function(e){return e="#"===e[0]?e.substr(1,e.length):e,document.getElementById(e)}(e.substr(1))];break;case".":o=r.call(t.getElementsByClassName(e.substr(1).replace(s," ")));break;default:o=r.call(t.getElementsByTagName(e))}else o=r.call(t.querySelectorAll(e));return n?o:o[0]}function l(e,t){return e.replace(/\{ *([\w_-]+) *\}/g,function(e,n){return function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}(void 0===t[n]?"":t[n])})}function u(e,t){let n;if(Array.isArray(e)){if(n=document.createElement(e[0]),e[1].id&&(n.id=e[1].id),e[1].classname&&(n.className=e[1].classname),e[1].attr){let t=e[1].attr;if(Array.isArray(t)){let e=-1;for(;++e<t.length;)n.setAttribute(t[e].name,t[e].value)}else n.setAttribute(t.name,t.value)}}else n=document.createElement(e);n.innerHTML=t;let s=document.createDocumentFragment();for(;n.childNodes[0];)s.appendChild(n.childNodes[0]);return n.appendChild(s),n}function p(e){return new RegExp("(^|\\s+) "+e+" (\\s+|$)")}function d(e,t,n){e.classList?e.classList.add(t):e.className=(e.className+" "+t).trim(),n&&s(n)&&window.setTimeout(function(){return h(e,t)},n)}function h(e,t,n){e.classList?e.classList.remove(t):e.className=e.className.replace(p(t)," ").trim(),n&&s(n)&&window.setTimeout(function(){return d(e,t)},n)}function g(e){return new Promise(function(t,n){const s=function(e,t){t&&"object"==typeof t&&(e+=(/\?/.test(e)?"&":"?")+m(t));return e}(e.url,e.data),r={method:"GET",mode:"cors"};e.jsonp?function(e,t,n){let s=document.head,r=document.createElement("script"),o="f"+Math.round(Math.random()*Date.now());r.setAttribute("src",e+(e.indexOf("?")>0?"&":"?")+t+"="+o),window[o]=function(e){window[o]=void 0,setTimeout(function(){return s.removeChild(r)},0),n(e)},s.appendChild(r)}(s,e.callbackName,t):fetch(s,r).then(function(e){return e.json()}).then(t).catch(n)})}function m(e){return Object.keys(e).reduce(function(t,n){return t.push("object"==typeof e[n]?m(e[n]):encodeURIComponent(n)+"="+encodeURIComponent(e[n])),t},[]).join("&")}e=e&&e.hasOwnProperty("default")?e.default:e;var f={namespace:"ol-geocoder",spin:"gcd-pseudo-rotate",hidden:"gcd-hidden",country:"gcd-country",city:"gcd-city",road:"gcd-road",olControl:"ol-control",glass:{container:"gcd-gl-container",control:"gcd-gl-control",button:"gcd-gl-btn",input:"gcd-gl-input",expanded:"gcd-gl-expanded",reset:"gcd-gl-reset",result:"gcd-gl-result"},inputText:{container:"gcd-txt-container",control:"gcd-txt-control",input:"gcd-txt-input",reset:"gcd-txt-reset",icon:"gcd-txt-glass",result:"gcd-txt-result"}},y={containerId:"gcd-container",buttonControlId:"gcd-button-control",inputQueryId:"gcd-input-query",inputResetId:"gcd-input-reset",cssClasses:f};const v=Object.freeze({containerId:"gcd-container",buttonControlId:"gcd-button-control",inputQueryId:"gcd-input-query",inputResetId:"gcd-input-reset",cssClasses:f,default:y}),b={ADDRESSCHOSEN:"addresschosen"},w={NOMINATIM:"nominatim",REVERSE:"reverse"},E={GLASS:"glass-button",INPUT:"text-input"},S=[new e.style.Style({image:new e.style.Icon({anchor:[.5,1],scale:.7,src:"//cdn.rawgit.com/jonataswalker/map-utils/master/images/marker.png"})})],k={OSM:"osm",MAPQUEST:"mapquest",GOOGLE:"google",PHOTON:"photon",BING:"bing",PELIAS:"pelias"},N={provider:k.OSM,placeholder:"Search for an address",featureStyle:S,targetType:E.GLASS,lang:"en-US",limit:5,keepOpen:!1,preventDefault:!1,autoComplete:!1,autoCompleteMinLength:2,debug:!1},x=v.cssClasses;var C=function(e){this.options=e.options,this.els=this.createControl()};C.prototype.createControl=function(){let e,t,n;return this.options.targetType===E.INPUT?(t=x.namespace+" "+x.inputText.container,n={container:e=u(["div",{id:v.containerId,classname:t}],C.input),control:c("."+x.inputText.control,e),input:c("."+x.inputText.input,e),reset:c("."+x.inputText.reset,e),result:c("."+x.inputText.result,e)}):(t=x.namespace+" "+x.glass.container,n={container:e=u(["div",{id:v.containerId,classname:t}],C.glass),control:c("."+x.glass.control,e),button:c("."+x.glass.button,e),input:c("."+x.glass.input,e),reset:c("."+x.glass.reset,e),result:c("."+x.glass.result,e)}),n.input.placeholder=this.options.placeholder,n},C.glass=['<div class="',x.glass.control," ",x.olControl,'">','<button type="button"',' id="',v.buttonControlId,'"',' class="',x.glass.button,'"></button>','<input type="text"',' id="',v.inputQueryId,'"',' class="',x.glass.input,'"',' autocomplete="off" placeholder="Search ...">',"<a",' id="',v.inputResetId,'"',' class="',x.glass.reset," ",x.hidden,'"',"></a>","</div>",'<ul class="',x.glass.result,'"></ul>'].join(""),C.input=['<div class="',x.inputText.control,'">','<input type="text"',' id="',v.inputQueryId,'"',' class="',x.inputText.input,'"',' autocomplete="off" placeholder="Search ...">','<span class="',x.inputText.icon,'"></span>','<button type="button"',' id="',v.inputResetId,'"',' class="',x.inputText.reset," ",x.hidden,'"',"></button>","</div>",'<ul class="',x.inputText.result,'"></ul>'].join("");var L=function(){this.settings={url:"http://photon.komoot.de/api/",params:{q:"",limit:10,lang:"en"},langs:["de","it","fr","en"]}};L.prototype.getParameters=function(e){return e.lang=e.lang.toLowerCase(),{url:this.settings.url,params:{q:e.query,limit:e.limit||this.settings.params.limit,lang:this.settings.langs.indexOf(e.lang)>-1?e.lang:this.settings.params.lang}}},L.prototype.handleResponse=function(e){return e.map(function(e){return{lon:e.geometry.coordinates[0],lat:e.geometry.coordinates[1],address:{name:e.properties.name,postcode:e.properties.postcode,city:e.properties.city,state:e.properties.state,country:e.properties.country},original:{formatted:e.properties.name,details:e.properties}}})};var R=function(){this.settings={url:"http://nominatim.openstreetmap.org/search/",params:{q:"",format:"json",addressdetails:1,limit:10,countrycodes:"","accept-language":"en-US"}}};R.prototype.getParameters=function(e){return{url:this.settings.url,params:{q:e.query,format:"json",addressdetails:1,limit:e.limit||this.settings.params.limit,countrycodes:e.countrycodes||this.settings.params.countrycodes,"accept-language":e.lang||this.settings.params["accept-language"]}}},R.prototype.handleResponse=function(e){return e.map(function(e){return{lon:e.lon,lat:e.lat,address:{name:e.address.neighbourhood||"",road:e.address.road||"",postcode:e.address.postcode,city:e.address.city||e.address.town,state:e.address.state,country:e.address.country},original:{formatted:e.display_name,details:e.address}}})};var T=function(){this.settings={url:"http://open.mapquestapi.com/nominatim/v1/search.php",params:{q:"",key:"",format:"json",addressdetails:1,limit:10,countrycodes:"","accept-language":"en-US"}}};T.prototype.getParameters=function(e){return{url:this.settings.url,params:{q:e.query,key:e.key,format:"json",addressdetails:1,limit:e.limit||this.settings.params.limit,countrycodes:e.countrycodes||this.settings.params.countrycodes,"accept-language":e.lang||this.settings.params["accept-language"]}}},T.prototype.handleResponse=function(e){return e.map(function(e){return{lon:e.lon,lat:e.lat,address:{name:e.address.neighbourhood||"",road:e.address.road||"",postcode:e.address.postcode,city:e.address.city||e.address.town,state:e.address.state,country:e.address.country},original:{formatted:e.display_name,details:e.address}}})};var I=function(){this.settings={url:"http://search.mapzen.com/v1/search",params:{text:"",key:"",size:10}}};I.prototype.getParameters=function(e){return{url:this.settings.url,params:{text:e.query,key:e.key,size:e.limit||this.settings.params.size}}},I.prototype.handleResponse=function(e){return e.map(function(e){return{lon:e.geometry.coordinates[0],lat:e.geometry.coordinates[1],address:{name:e.properties.name,house_number:e.properties.housenumber,postcode:e.properties.postalcode,road:e.properties.street,city:e.properties.city,state:e.properties.region,country:e.properties.country},original:{formatted:e.properties.label,details:e.properties}}})};var P=function(){this.settings={url:"https://maps.googleapis.com/maps/api/geocode/json",params:{address:"",key:"",language:"en-US"}}};P.prototype.getParameters=function(e){return{url:this.settings.url,params:{address:e.query,key:e.key,language:e.lang||this.settings.params.language}}},P.prototype.handleResponse=function(e){const t=["point_of_interest","establishment","natural_feature","airport"],n=["street_address","route","sublocality_level_5","intersection"],s=["postal_code"],o=["locality"],a=["administrative_area_level_1"],i=["country"];let c=[];return e.forEach(function(e){let l=function(e){let c={name:"",road:"",postcode:"",city:"",state:"",country:""};return e.forEach(function(e){r(e.types,t)?c.name=e.long_name:r(e.types,n)?c.road=e.long_name:r(e.types,s)?c.postcode=e.long_name:r(e.types,o)?c.city=e.long_name:r(e.types,a)?c.state=e.long_name:r(e.types,i)&&(c.country=e.long_name)}),c}(e.address_components);(function(e,t){return void 0===t&&(t=!1),Object.keys(e).forEach(function(n){(function(e){return!e||0===e.length})(e[n])||(t=!0)}),t})(l)&&c.push({lon:e.geometry.location.lng,lat:e.geometry.location.lat,address:{name:l.name,postcode:l.postcode,road:l.road,city:l.city,state:l.state,country:l.country},original:{formatted:e.formatted_address,details:e.address_components}})}),c};var A=function(){this.settings={url:"https://dev.virtualearth.net/REST/v1/Locations",callbackName:"jsonp",params:{query:"",key:"",includeNeighborhood:0,maxResults:10}}};A.prototype.getParameters=function(e){return{url:this.settings.url,callbackName:this.settings.callbackName,params:{query:e.query,key:e.key,includeNeighborhood:e.includeNeighborhood||this.settings.params.includeNeighborhood,maxResults:e.maxResults||this.settings.params.maxResults}}},A.prototype.handleResponse=function(e){return e.map(function(e){return{lon:e.point.coordinates[1],lat:e.point.coordinates[0],address:{name:e.name},original:{formatted:e.address.formattedAddress,details:e.address}}})};const O=v.cssClasses;var j=function(t,s){this.Base=t,this.layerName=n("geocoder-layer-"),this.layer=new e.layer.Vector({name:this.layerName,source:new e.source.Vector}),this.options=t.options,this.options.provider="string"==typeof this.options.provider?this.options.provider.toLowerCase():this.options.provider,this.els=s,this.lastQuery="",this.container=this.els.container,this.registeredListeners={mapClick:!1},this.setListeners(),this.Photon=new L,this.OpenStreet=new R,this.MapQuest=new T,this.Pelias=new I,this.Google=new P,this.Bing=new A};j.prototype.setListeners=function(){var e=this;let t,n;const s=function(){i(e.els.control,O.glass.expanded)?e.collapse():e.expand()};this.els.input.addEventListener("keypress",function(t){const n=t.target.value.trim();(t.key?"Enter"===t.key:t.which?13===t.which:!!t.keyCode&&13===t.keyCode)&&(t.preventDefault(),e.query(n))},!1),this.els.input.addEventListener("input",function(s){const r=s.target.value.trim();r.length?a(e.els.reset,O.hidden):o(e.els.reset,O.hidden),e.options.autoComplete&&r!==n&&(n=r,t&&clearTimeout(t),t=setTimeout(function(){r.length>=e.options.autoCompleteMinLength&&e.query(r)},200))},!1),this.els.reset.addEventListener("click",function(t){e.els.input.focus(),e.els.input.value="",e.lastQuery="",o(e.els.reset,O.hidden),e.clearResults()},!1),this.options.targetType===E.GLASS&&this.els.button.addEventListener("click",s,!1)},j.prototype.query=function(e){var t=this;const n=this.getProvider({query:e,provider:this.options.provider,key:this.options.key,lang:this.options.lang,countrycodes:this.options.countrycodes,limit:this.options.limit});if(this.lastQuery===e&&this.els.result.firstChild)return;this.lastQuery=e,this.clearResults(),o(this.els.reset,O.spin);let s={url:n.url,data:n.params};n.callbackName&&(s.jsonp=!0,s.callbackName=n.callbackName),g(s).then(function(e){t.options.debug&&console.info(e),a(t.els.reset,O.spin);let n;switch(t.options.provider){case k.OSM:n=e.length?t.OpenStreet.handleResponse(e):void 0;break;case k.MAPQUEST:n=e.length?t.MapQuest.handleResponse(e):void 0;break;case k.PELIAS:n=e.features.length?t.Pelias.handleResponse(e.features):void 0;break;case k.PHOTON:n=e.features.length?t.Photon.handleResponse(e.features):void 0;break;case k.GOOGLE:n=e.results.length?t.Google.handleResponse(e.results):void 0;break;case k.BING:n=e.resourceSets[0].resources.length?t.Bing.handleResponse(e.resourceSets[0].resources):void 0;break;default:n=t.options.provider.handleResponse(e)}n&&(t.createList(n),t.listenMapClick())}).catch(function(e){a(t.els.reset,O.spin);const n=u("li","<h5>Error! No internet connection?</h5>");t.els.result.appendChild(n)})},j.prototype.createList=function(e){var t=this;const n=this.els.result;e.forEach(function(e){let s=t.addressTemplate(e.address),r=u("li",['<a href="#">',s,"</a>"].join(""));r.addEventListener("click",function(n){n.preventDefault(),t.chosen(e,s,e.address,e.original)},!1),n.appendChild(r)})},j.prototype.chosen=function(t,n,s,r){const o=this.Base.getMap(),a=[parseFloat(t.lon),parseFloat(t.lat)],i=o.getView().getProjection(),c=e.proj.transform(a,"EPSG:4326",i);let l=t.bbox;l&&(l=e.proj.transformExtent(l,"EPSG:4326",i));const u={formatted:n,details:s,original:r};if(!1===this.options.keepOpen&&this.clearResults(!0),!0===this.options.preventDefault)this.Base.dispatchEvent({type:b.ADDRESSCHOSEN,address:u,coordinate:c,bbox:l});else{l?o.getView().fit(l,{duration:500}):function(e,t,n,s){s=s||2.388657133911758,n=n||500,e.getView().animate({duration:n,resolution:s},{duration:n,center:t})}(o,c);const e=this.createFeature(c,u);this.Base.dispatchEvent({type:b.ADDRESSCHOSEN,address:u,feature:e,coordinate:c,bbox:l})}},j.prototype.createFeature=function(t){const s=new e.Feature(new e.geom.Point(t));return this.addLayer(),s.setStyle(this.options.featureStyle),s.setId(n("geocoder-ft-")),this.getSource().addFeature(s),s},j.prototype.addressTemplate=function(e){let t=[];return e.name&&t.push(['<span class="',O.road,'">{name}</span>'].join("")),(e.road||e.building||e.house_number)&&t.push(['<span class="',O.road,'">{building} {road} {house_number}</span>'].join("")),(e.city||e.town||e.village)&&t.push(['<span class="',O.city,'">{postcode} {city} {town} {village}</span>'].join("")),(e.state||e.country)&&t.push(['<span class="',O.country,'">{state} {country}</span>'].join("")),l(t.join("<br>"),e)},j.prototype.getProvider=function(e){let t;switch(e.provider){case k.OSM:t=this.OpenStreet.getParameters(e);break;case k.MAPQUEST:t=this.MapQuest.getParameters(e);break;case k.PHOTON:t=this.Photon.getParameters(e);break;case k.GOOGLE:t=this.Google.getParameters(e);break;case k.PELIAS:t=this.Pelias.getParameters(e);break;case k.BING:t=this.Bing.getParameters(e);break;default:t=e.provider.getParameters(e)}return t},j.prototype.expand=function(){var e=this;a(this.els.input,O.spin),o(this.els.control,O.glass.expanded),window.setTimeout(function(){return e.els.input.focus()},100),this.listenMapClick()},j.prototype.collapse=function(){this.els.input.value="",this.els.input.blur(),o(this.els.reset,O.hidden),a(this.els.control,O.glass.expanded),this.clearResults()},j.prototype.listenMapClick=function(){if(this.registeredListeners.mapClick)return;const e=this,t=this.Base.getMap().getTargetElement();this.registeredListeners.mapClick=!0,t.addEventListener("click",{handleEvent:function(n){e.clearResults(!0),t.removeEventListener(n.type,this,!1),e.registeredListeners.mapClick=!1}},!1)},j.prototype.clearResults=function(e){e&&this.options.targetType===E.GLASS?this.collapse():function(e){for(;e.firstChild;)e.removeChild(e.firstChild)}(this.els.result)},j.prototype.getSource=function(){return this.layer.getSource()},j.prototype.addLayer=function(){var e=this;let t=!1;const n=this.Base.getMap();n.getLayers().forEach(function(n){n===e.layer&&(t=!0)}),t||n.addLayer(this.layer)};return function(e){function n(s,r){if(void 0===s&&(s=w.NOMINATIM),void 0===r&&(r={}),!(this instanceof n))return new n;t("string"==typeof s,"@param `type` should be string!"),t(s===w.NOMINATIM||s===w.REVERSE,"@param 'type' should be '"+w.NOMINATIM+"'\n        or '"+w.REVERSE+"'!"),t("object"==typeof r,"@param `options` should be object!"),this.options=function(e,t){let n={};for(let t in e)n[t]=e[t];for(let e in t)n[e]=t[e];return n}(N,r),this.container=void 0;let o;const a=new C(this);s===w.NOMINATIM?(this.container=a.els.container,o=new j(this,a.els),this.layer=o.layer):w.REVERSE,e.call(this,{element:this.container})}return e&&(n.__proto__=e),n.prototype=Object.create(e&&e.prototype),n.prototype.constructor=n,n.prototype.getLayer=function(){return this.layer},n.prototype.getSource=function(){return this.getLayer().getSource()},n}(e.control.Control)});
